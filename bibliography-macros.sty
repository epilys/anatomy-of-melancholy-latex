\RequirePackage{hyperref}
\RequirePackage{xfp,xparse}
\RequirePackage[
  bibstyle=art-numeric,
  citestyle=numeric,
  backref=true,
  datecirca=true,
  dateuncertain=true,
  dateabbrev=false,
  sorting=none,
  datezeros=false,% pad date components with zeros?
  dateera=secular,
  defernumbers=true,
]{biblatex}

\DefineBibliographyStrings{english}{%
  backrefpage = {page},% originally "cited on page"
  backrefpages = {pages},% originally "cited on pages"
}

\renewcommand*{\datecircadelim}{~}
\DeclareFieldFormat{italics}{\textit{#1}}
\DeclareFieldFormat{annote}{\tiny#1\par}
\DeclareFieldFormat{url}{{\Urlmuskip = 1mu plus 1mu\textsc{URL}\addcolon\space\url{#1}}}
\DeclareFieldFormat{onlineidentifier}{\nobreak{\textsc{ID}\addcolon\space\texttt{#1}}}
\DeclareFieldFormat{includeart}{\includegraphics[keepaspectratio,width=0.85\textwidth]{#1}}
\DeclareFieldFormat{includeartthumb}{{\graphicspath{{./figures/thumbs/}}\includegraphics[keepaspectratio,width=0.85\textwidth]{#1}}}

\edef\GoldenRatio{\fpeval{(sqrt(5)+1)/2}} % x
\edef\GoldenRatioPlusOne{\fpeval{\GoldenRatio+1}} % x

\newsavebox{\TmpBoxForWidths}
\newlength\ArtThumbnailWidth
\newlength\tmpAReg
\newlength\tmpBReg
\newlength\tmpCReg
\newlength\ArtInfoWidth

\savebox{\TmpBoxForWidths}{\mbox{thumbnail:}}%
\setlength\ArtThumbnailWidth{\wd\TmpBoxForWidths}%

\setlength\tmpAReg{\fpeval{\textwidth/\GoldenRatioPlusOne}pt}
\setlength\tmpBReg{\GoldenRatio\tmpAReg}
\setlength\tmpCReg{\tmpAReg-\PageRefLabelWidth-\ArtThumbnailWidth}
\setlength\ArtInfoWidth{\tmpBReg}%

\DeclareBibliographyDriver{misc}{%
  \usebibmacro{bibindex}%
  \usebibmacro{begentry}%
  \hspace{\tmpCReg}%
  {\begin{minipage}{\ArtThumbnailWidth}%
    {%
      {%
        \iffieldundef{file}{non}{%
          \printfield[includeartthumb]{file}%
          }%
          }%
          }
  \end{minipage}%
  }%
  {\begin{minipage}{\ArtInfoWidth}
    {\small{}%
    \begin{spacing}{0.95}%
      \usebibmacro{author}%
      \setunit{\addcomma\space}\newblock
      \printfield[italics]{title}%
      \newunit\newblock
      \setunit*{\addcomma\space}%
      \printfield{type}%
      \newunit\newblock
      \setunit*{\addcomma\space}%
      \printdate%
    \end{spacing}%
    \newunit
    \setunit*{}
    \vspace{0.3\baselineskip}
    {\scriptsize{}%
    \begin{spacing}{1}%
      {\iffieldundef{eid}{}{\printfield[onlineidentifier]{eid}\\*}}%
      \usebibmacro{url}%
    \end{spacing}%
    }%
    }
  \end{minipage}%
  }%
  }

\DeclareCiteCommand{\citeyearuncertain}
  {\boolfalse{citetracker}%
   \boolfalse{pagetracker}%
   \usebibmacro{prenote}}
  {\iffieldundef{year}{undefined}{\printdate}}
  {\multicitedelim}
  {\usebibmacro{postnote}}

% We want to see how many lines the annotation text would be if typeset in one
  % column, of width 0.6\textwidth. Create a box to store the column and a
  % length to store the number of lines:
\newlength\AnnotationBoxLinesNo
\newsavebox{\AnnotationBox}

% Create lengths to store the height of a single line typeset with the \tiny font
\newsavebox{\LineHeightTmpBox}
\newlength\tnotefontheight
\savebox{\LineHeightTmpBox}{\parbox{\textwidth}{{\tiny{}H}}}
\setlength\tnotefontheight{\ht\LineHeightTmpBox}
%\newlength\snotefontheight
%\savebox{\LineHeightTmpBox}{\parbox{\textwidth}{{\scriptsize{}\notefont{}H}}}
%\setlength\snotefontheight{\ht\LineHeightTmpBox}
%\showthe\snotefontheight %5.67578pt.
%\showthe\tnotefontheight %5.00684pt.

\DeclareCiteCommand{\citeannotation}
  {\boolfalse{citetracker}%
   \boolfalse{pagetracker}%
   \usebibmacro{prenote}}
  {\iffieldundef{annotation}{}{%
    % Typeset the annotation text in a column but don't display it, instead
    % save it in a box
    \savebox{\AnnotationBox}{\parbox{0.6\textwidth}{{\centering\printfield[annote]{annotation}}}}%
    % Divide the height of the box with the height of a single line to
    % calculate how many lines it is.
    \setlength\AnnotationBoxLinesNo{\dimexpr\numexpr((\ht\AnnotationBox)/\tnotefontheight)\relax pt\relax}%
    % Don't show one column if it's more than 5 lines, instead do two columns
    % with the multicols environment
    \ifdim\AnnotationBoxLinesNo>5pt\relax%
    {%
      \vspace{-1.2\baselineskip}%
      \begin{multicols}{2}%
        \printfield[annote]{annotation}%
      \end{multicols}}%
      \else%
      {\centering%
      \vspace{-0.6\baselineskip}%
      \noindent\usebox{\AnnotationBox}\par%
      }%
      \fi%
  }}%
  {\multicitedelim}
  {\usebibmacro{postnote}}

\DeclareCiteCommand{\citetitleit}
  {\boolfalse{citetracker}%
   \boolfalse{pagetracker}%
   \usebibmacro{prenote}}
  {\printfield[italics]{title}}
  {\multicitedelim}
  {\usebibmacro{postnote}}

\newcommand{\citeart}[1]{\protect\citeauthor{#1}, \protect\citetitleit{#1}, \protect\citeyearuncertain{#1}, \protect\citefield{#1}{type}.\protect\nocite{#1}}
\newcommand{\captionart}[1]{\caption{\citeart{#1}}%
  \endgroup%
\protect\citeannotation{#1}}
